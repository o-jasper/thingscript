#!/bin/bash
#
#  Copyright (C) 30-05-2013 Jasper den Ouden.
#
#  This is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published
#  by the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#

#Start of working with thingtracker.
#TODO we MUST additionally enforce `self_link`(`URL`)

if [ "$1" != "" ]; then
    cd $1
    export OPWD=$OPWD
    export PWD=$PWD
fi

g()
{   FILE=$(thingscript get $1)
    if [ "$FILE" != "" ]; then
        cat $FILE
    fi
} 
p()
{   GOT=$(g $1)
    if [ "$GOT" != "" ]; then
        NAME=$2
        if [ "$NAME" == "" ]; then
            NAME=$1
        fi
        echo \"$NAME\":\"$GOT\",
    fi
}

run() #Just elements.
{   echo '{"things":
{{'
    p title
    URL=$(thingscript url self_link)
    if [ "$URL" != "" ]; then
        echo '"URL":"'$URL\",
    else
        echo 'An url is required! Need file thingscript/self_url' > /dev/stderr
    fi
    p author
    p license
    p short_description description
    THUMB_URL=$(thingscript url thumbnail)
    if [ "$THUMB_URL" != "" ]; then
        echo '"thumbnailURL":"'$THUMB_URL\",
    fi
    TAGS=$(thingscript get tags)
    if [ "$TAGS" != "" ]; then
        echo -n '"tags":['
        FIRST="true"
        grep -xvP '#.+' $TAGS | while read line; do
            if [ "$FIRST" == "true" ]; then
                FIRST="false"
                echo -n \"$line\"
            else
                echo -n ,\"$line\"
            fi 
        done
        echo ']'
    fi
    echo '}},'
    echo -n '"trackers:{'
    if [ "$URL" != "" ]; then
        echo -n '"URL":"'$URL/thing.tracker.json\"
    fi
    echo '}'
    echo }
}

if [ "$2" == stdout ]; then
    run
else
    run > one_thing.tracker.json
fi
