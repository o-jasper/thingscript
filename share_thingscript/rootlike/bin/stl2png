#!/bin/bash
#
#  Copyright (C) 22-05-2013 Jasper den Ouden.
#
#  This is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#

#Uses povray to generate an image from an .stl

FILE=$1
OUT_FILE=$2
if [ "$OUT_FILE" == ""]; then
    OUT_FILE=$FILE.png
fi
POV_ARGS=$3

STL2PNG_DIR=$ROOTLIKE/share/stl2png/

#Generate povray file.
TMP_INC=/tmp/`date +%s`$RANDOM.inc
stl2pov.py $FILE $TMP_INC

# Produces crud infront, with unusable variable name, fix that.
echo '# declare draw_model = mesh {' > $FILE.pov
tail -n+14 $TMP_INC >> $FILE.pov
# Dont need the temporary anymore.
rm $TMP_INC
#Add the actual drawing of the thing
#TODO better way of using templates..
cat $STL2PNG_DIR/template_pre.pov >> $FILE.pov

#Use admesh info.. Yeah program writes should provide better access to data.
#TODO get stl info stores data more neatly.
val() #Expr sucks. Well, bash sucks.
{   cut -f1 -d.
}
gi()
{   $ROOTLIKE/bin/get_stl_info $FILE | grep "Min $1" | cut -f$2 -d= | cut -f1 -d, | val
}

FX=`gi X 2`
TX=`gi X 3`

FY=`gi Y 2`
TY=`gi Y 3`

FZ=`gi Z 2`
TZ=`gi Z 3`

av()
{   expr 1000 \* \( $1 + $2 \) / 2000 
}
#Look at center.
echo look_at \<`av $FX $TX`, `av $FY $TY`, `av $FZ $TZ`\> >> $FILE.pov
#Look from slight distance.
echo location \<`expr 2 \* $TX - $FX`, `expr 2 \* $TY - $FY`, `expr 2 \* $FZ - $TZ`\> >> $FILE.pov

cat $STL2PNG_DIR/template_post.pov >> $FILE.pov

#Actually run povray.
povray $FILE.pov $POV_ARGS +O$OUT_FILE > /dev/null
