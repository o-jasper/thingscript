#!/bin/bash
#
#  Copyright (C) 18-05-2013 Jasper den Ouden.
#
#  This is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#

if [ WHICH_TYPE=="" ]; then
    WHICH_TYPE="main"
fi

#Dont know why the double loop didnt work, bash sucks.
get_locations()
{
    for el in `echo $@`; do #First what the user tells you to do.
        echo $PROJECT_DIR/thingscript/$el
    done
    for el in `echo $@`; do #Then what he prefers.
        echo ~/.thingscript/$WHICH_TYPE/$el
    done
    for el in `echo $@`; do #Then what the admin suggests.
        echo /etc/thingscript/$WHICH_TYPE/$el
    done
    for el in `echo $@`; do #Then what the dev suggests.
        echo /usr/share/thingscript/$WHICH_TYPE/$el
    done
    if [ "$WHICH_TYPE" != "main" ]; then #If you run out try main anyway.
        for el in `echo $@`; do 
            echo ~/.thingscript/main/$el
        done
        for el in `echo $@`; do
            echo /etc/thingscript/main/$el
        done
        for el in `echo $@`; do
            echo /usr/share/thingscript/main/$el
        done
    fi
}

#Gets layout information.
get()
{   for el in `get_locations $@`; do #Go through all the files.
        if `test -e $el`; then  #See if the file exists.
            echo $el
            return #Have one.
        fi
    done
}

get_page()
{   get $2.html $2.md $2.html_ $2.md_ $2
}

get_image()
{ 
    get $1.png $1.jpg $1.svg $1.gif
}

handle_get()
{
    handle "`get_page $@`"
}

cat_get()
{   cat "`get $@`"
}

#Handles pages, possibly doing scripts/substitutions within.
handle()
{
    if [ "$1" == "" ]; then #Nothing here.
        return
    fi
    if [ ! -e $1 ]; then #File doesnt exist.
        exit #TODO do something?
    fi
    VAL=`echo $1 | cut -f 3 -d'.'`
    if [ "$VAL" = "" ]; then
        VAL=`echo $1 | cut -f 2 -d'.'`
    fi
    case "$VAL" in
        html)
            cat $1;;
        md)
            markdown $1;;
        html_)  #Recurse.
            cat $1 | handle_whole;;
        md_)
            markdown $1 | handle_whole ;;
        *) 
            cat $1 ;;
    esac
}

cat_or_run() #List 
{
    if [ "$1" == "" ]; then
        $2
    else
        cat $1
    fi
}

#TODO make handling external. (Its needed top make things elements.)
#Warning, dont use single loose words.
handle_whole()
{
    tr '$' '\n' | while read LINE; do
        FIRST=`echo "$LINE" | cut -f 1 -d ' '`
        if [ "$FIRST" == "" ]; then
            echo $LINE
            continue
        fi
        GOT=`get elements/$FIRST`
        if [ "$GOT" != "" ]; then  #Got something, yay.
            $GOT $LINE #Run it
            continue
        fi
        case "$LINE" in
            *.cat)
                cat_get `echo $LINE | head -c-2` ;;
            *_) #Layout stuff.
                handle_get `echo $LINE | head -c-2` ;;
            *) #Just a plain line to be outputted.
                echo $LINE ;;
        esac
    done
}


get_help()
{   FILE=`get help/$1`
    if `test -d $FILE"`; then
        echo $FILE/readme.md
    else
        echo $FILE
    fi
}

case "$1" in
    get)
        get $@;;
    get_page)
        get_page $@;;
    get_image)
        get_image $@;;
    
    help) #Help stdout.
        cat "`get_help $2`"
        if [ "$?" != "0" ]; then
            echo Turns out no help page for $2 exists.
        fi;;
    help_browser) #Help into browser. TODO probably want CSS.
        mkdir -p /tmp/thingscript/
        HTML_FILE=/tmp/thingscript/`date +%s`$RANDOM.html
        markdown "`get_help $2`" > $HTML_FILE
        if [ "$?" != "0" ]; then
            echo Turns out no help page for $2 exists.
        fi
        PREFERRED=`get prefer/browser`
        if [ "$PREFERRED" == "" ]; then
            PREFERRED="xdg-open"
        fi
        $PREFERRED $HTML_FILE;;
    
    mkpage)
        sh "`get bin/mkpage.sh`" $2;;

    version)
        cat /usr/share/thingscript/version;;

    handle)
        handle $2;;
    handle_get)
        handle "`get_page $@`";;
    cat_get)
        cat_get $@;;
    markdown_get)
        markdown "`get $@`";;
    *) #TODO more info, `help`
        echo Did not recognize thingscript command $1 > /dev/stderr
esac
